{"title":"阅读vue源码前的准备工作","uid":"09fa92eab7d534581236b19377694635","slug":"源码阅读笔记/vue/阅读vue源码前的准备工作","date":"2024-05-05T06:52:32.000Z","updated":"2024-05-05T06:52:33.999Z","comments":true,"path":"api/articles/源码阅读笔记/vue/阅读vue源码前的准备工作.json","keywords":null,"cover":null,"content":"<h1 id=\"认识Flow\"><a href=\"#认识Flow\" class=\"headerlink\" title=\"认识Flow\"></a>认识Flow</h1><p>Flow是facebook出品的javascript静态类型检查工具，vue源码中使用了Flow。</p>\n<p>flow的语法类似typescript，区别在于typescript需要将文件后缀名改成.ts，flow在前边加个注释就行</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// @flow</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">add</span>(<span class=\"params\">x: number, y: number</span>): number &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> x + y</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title function_\">add</span>(<span class=\"string\">&#x27;Hello&#x27;</span>, <span class=\"number\">11</span>)</span><br></pre></td></tr></table></figure>\n\n<p>有时候我们想引用第三方库，或者自定义一些类型，但 Flow 并不认识，因此检查的时候会报错。为了解决这类问题，Flow 提出了一个 <code>libdef</code> 的概念，可以用来识别这些第三方库或者是自定义类型，而 Vue.js 也利用了这一特性。</p>\n<p>在 Vue.js 的主目录下有 <code>.flowconfig</code> 文件， 它是 Flow 的配置文件，感兴趣的同学可以看<a href=\"https://flow.org/en/docs/config/\">官方文档</a>。这其中的 <code>[libs]</code> 部分用来描述包含指定库定义的目录，默认是名为 <code>flow-typed</code> 的目录。</p>\n<p>这里 <code>[libs]</code> 配置的是 <code>flow</code>，表示指定的库定义都在 <code>flow</code> 文件夹内。我们打开这个目录，会发现文件如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">flow</span><br><span class=\"line\">├── compiler.js        # 编译相关</span><br><span class=\"line\">├── component.js       # 组件数据结构</span><br><span class=\"line\">├── global-api.js      # Global API 结构</span><br><span class=\"line\">├── modules.js         # 第三方库定义</span><br><span class=\"line\">├── options.js         # 选项相关</span><br><span class=\"line\">├── ssr.js             # 服务端渲染相关</span><br><span class=\"line\">├── vnode.js           # 虚拟 node 相关</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，Vue.js 有很多自定义类型的定义，在阅读源码的时候，如果遇到某个类型并想了解它完整的数据结构的时候，可以回来翻阅这些数据结构的定义。</p>\n<h1 id=\"Vue-js-源码目录设计\"><a href=\"#Vue-js-源码目录设计\" class=\"headerlink\" title=\"Vue.js 源码目录设计\"></a>Vue.js 源码目录设计</h1><p>Vue.js 的源码都在 src 目录下，其目录结构如下。</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">src</span><br><span class=\"line\">├── compiler        # 编译相关 </span><br><span class=\"line\">├── core            # 核心代码 </span><br><span class=\"line\">├── platforms       # 不同平台的支持</span><br><span class=\"line\">├── server          # 服务端渲染</span><br><span class=\"line\">├── sfc             # .vue 文件解析</span><br><span class=\"line\">├── shared          # 共享代码</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"compiler\"><a href=\"#compiler\" class=\"headerlink\" title=\"compiler\"></a>compiler</h2><p>compiler 目录包含 Vue.js 所有编译相关的代码。它包括把模板解析成 ast 语法树，ast 语法树优化，代码生成等功能。</p>\n<p>编译的工作可以在构建时做（借助 webpack、vue-loader 等辅助插件）；也可以在运行时做，使用包含构建功能的 Vue.js。显然，编译是一项耗性能的工作，所以更推荐前者——离线编译。</p>\n<h2 id=\"core\"><a href=\"#core\" class=\"headerlink\" title=\"core\"></a>core</h2><p>core 目录包含了 Vue.js 的核心代码，包括内置组件、全局 API 封装，Vue 实例化、观察者、虚拟 DOM、工具函数等等。</p>\n<p>这里的代码可谓是 Vue.js 的灵魂，也是我们之后需要重点分析的地方。</p>\n<h2 id=\"platform\"><a href=\"#platform\" class=\"headerlink\" title=\"platform\"></a>platform</h2><p>Vue.js 是一个跨平台的 MVVM 框架，它可以跑在 web 上，也可以配合 weex 跑在 native 客户端上。platform 是 Vue.js 的入口，2 个目录代表 2 个主要入口，分别打包成运行在 web 上和 weex 上的 Vue.js。</p>\n<p>我们会重点分析 web 入口打包后的 Vue.js，对于 weex 入口打包的 Vue.js，感兴趣的同学可以自行研究。</p>\n<h2 id=\"server\"><a href=\"#server\" class=\"headerlink\" title=\"server\"></a>server</h2><p>Vue.js 2.0 支持了服务端渲染，所有服务端渲染相关的逻辑都在这个目录下。注意：这部分代码是跑在服务端的 Node.js，不要和跑在浏览器端的 Vue.js 混为一谈。</p>\n<p>服务端渲染主要的工作是把组件渲染为服务器端的 HTML 字符串，将它们直接发送到浏览器，最后将静态标记”混合”为客户端上完全交互的应用程序</p>\n<h2 id=\"sfc\"><a href=\"#sfc\" class=\"headerlink\" title=\"sfc\"></a>sfc</h2><p>通常我们开发 Vue.js 都会借助 webpack 构建， 然后通过 .vue 单文件来编写组件。</p>\n<p>这个目录下的代码逻辑会把 .vue 文件内容解析成一个 JavaScript 的对象。</p>\n<h2 id=\"shared\"><a href=\"#shared\" class=\"headerlink\" title=\"shared\"></a>shared</h2><p>Vue.js 会定义一些工具方法，这里定义的工具方法都是会被浏览器端的 Vue.js 和服务端的 Vue.js 所共享的</p>\n<h1 id=\"Vue-js-源码构建\"><a href=\"#Vue-js-源码构建\" class=\"headerlink\" title=\"Vue.js 源码构建\"></a>Vue.js 源码构建</h1><p>Vue.js 源码是基于 <a href=\"https://github.com/rollup/rollup\">Rollup</a> 构建的，它的构建相关配置都在 scripts 目录下。</p>\n<h2 id=\"构建脚本\"><a href=\"#构建脚本\" class=\"headerlink\" title=\"构建脚本\"></a>构建脚本</h2><p>通常一个基于 NPM 托管的项目都会有一个 package.json 文件，它是对项目的描述文件，它的内容实际上是一个标准的 JSON 对象。</p>\n<p>我们通常会配置 <code>script</code> 字段作为 NPM 的执行脚本，Vue.js 源码构建的脚本如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;script&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;build&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;node scripts/build.js&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;build:ssr&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;npm run build -- web-runtime-cjs,web-server-renderer&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;build:weex&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;npm run build -- weex&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>","text":"认识FlowFlow是facebook出品的javascript静态类型检查工具，vue源码中使用了Flow。 flow的语法类似typescript，区别在于...","permalink":"/post/源码阅读笔记/vue/阅读vue源码前的准备工作","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"vue","slug":"vue","count":7,"path":"api/tags/vue.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%AE%A4%E8%AF%86Flow\"><span class=\"toc-text\">认识Flow</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Vue-js-%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">Vue.js 源码目录设计</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#compiler\"><span class=\"toc-text\">compiler</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#core\"><span class=\"toc-text\">core</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#platform\"><span class=\"toc-text\">platform</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#server\"><span class=\"toc-text\">server</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#sfc\"><span class=\"toc-text\">sfc</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#shared\"><span class=\"toc-text\">shared</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Vue-js-%E6%BA%90%E7%A0%81%E6%9E%84%E5%BB%BA\"><span class=\"toc-text\">Vue.js 源码构建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC\"><span class=\"toc-text\">构建脚本</span></a></li></ol></li></ol>","author":{"name":"MessageWall","slug":"blog-author","avatar":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F0bcda423-149d-411d-a505-d29abc1ab6de%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1717404600&t=829a21da2f1f1a8181b572805d48b476","link":"/","description":"欢迎来到小王的博客～ <br/> 博客不定时更新，欢迎收藏","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"开始学习","uid":"0de3628c378178e45f54c2175e0c38c6","slug":"源码阅读笔记/vue-next/开始学习","date":"2024-05-05T06:52:32.000Z","updated":"2024-05-05T06:52:33.999Z","comments":true,"path":"api/articles/源码阅读笔记/vue-next/开始学习.json","keywords":null,"cover":null,"text":"初始化项目 clone 项目 1$ git clone https://github.com/vuejs/vue-next.git 安装项目依赖 1yarn i...","permalink":"/post/源码阅读笔记/vue-next/开始学习","photos":[],"count_time":{"symbolsCount":973,"symbolsTime":"1 mins."},"categories":[],"tags":[{"name":"vue-next","slug":"vue-next","count":7,"path":"api/tags/vue-next.json"}],"author":{"name":"MessageWall","slug":"blog-author","avatar":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F0bcda423-149d-411d-a505-d29abc1ab6de%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1717404600&t=829a21da2f1f1a8181b572805d48b476","link":"/","description":"欢迎来到小王的博客～ <br/> 博客不定时更新，欢迎收藏","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"React Hooks","uid":"a23763344ac54e792742fe2976e22df2","slug":"react/React Hooks","date":"2021-08-11T16:00:00.000Z","updated":"2024-05-05T06:22:14.222Z","comments":true,"path":"api/articles/react/React Hooks.json","keywords":null,"cover":[],"text":"React Hooks1. hooks总览 什么是react 的 hook 以及 react hooks 的由来官网解释：Hook 是 React 16.8 的...","permalink":"/post/react/React Hooks","photos":[],"count_time":{"symbolsCount":"22k","symbolsTime":"20 mins."},"categories":[{"name":"React","slug":"React","count":1,"path":"api/categories/React.json"}],"tags":[{"name":"React","slug":"React","count":1,"path":"api/tags/React.json"},{"name":"React Hooks","slug":"React-Hooks","count":1,"path":"api/tags/React-Hooks.json"}],"author":{"name":"MessageWall","slug":"blog-author","avatar":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F0bcda423-149d-411d-a505-d29abc1ab6de%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1717404600&t=829a21da2f1f1a8181b572805d48b476","link":"/","description":"欢迎来到小王的博客～ <br/> 博客不定时更新，欢迎收藏","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}